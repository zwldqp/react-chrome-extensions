# dao
dao 是一个异步请求 API 管理库，基于 [axios](https://github.com/axios/axios)。

## 功能
- 以业务实体为维度组织 API 配置
- 灵活的请求 Loading 配置
- 灵活的请求错误处理配置
- 支持规避请求重复提交
- 支持规避竞态请求
- 与 redux-thunk、redux-saga 等副作用处理库完美兼容
- API 与 axios 完全兼容
- 支持 TypeScript

## API 说明
#### 创建 dao 实例
```javascript
import dao from 'dao'
const userDAO = dao.create({
    get: '/api/users/:id',

    getList: '/api/users',

    update: {
        url: '/api/users/:id',
        method: 'POST',
        preventRepeated: true
    }
})
```
#### 使用 dao
```javascript
import userDAO from 'path/to/dao/user.js'

userDAO.get({
    loading: true,
    params: {
        _timestamp: Date.now()
    }
})
.then((response) => {
    // do something with response.data
})
.catch(error => {
    // do something with error/error.data
})
```
#### 配置项说明    
dao 在 axios 的基础上添加了4个新的配置：
```javascript
{
    /**
     * 调用 dao 方法发送请求时，
     * 是否自动调用 showLoading / hideLoading 回调函数
     * POST/PUT/DELETE/PATCH 等非幂请求，
     * loading 默认为 true
     * showLoading / hideLoading 的配置请参考下一节
     */
    loading: boolean; 
    /**
     * 在请求失败时，是否调用配置的 displayNotification 回调函数
     * displayNotification 的配置请参考下一节
     */
    preventNotification: boolean;
    /**
     * 是否阻止请求重复提交，在表单提交时比较有用
     */
    preventRepeated: boolean;
    /**
     * 是否只保留最新的一次请求，
     * 设置为 true 可防止先发的请求后到达导致数据不一致的 bug
     */
    takeLatest: boolean;
}
```
更多的配置项，请参考 [axios](https://github.com/axios/axios) 文档

#### 回调函数配置
请求发生的过程中，通常有以下需求：显示 Loading，在接口报错时，在页面上显示错误通知；dao 针对这两种场景，提供了 loading/notification 的配置，并且会自动在适当的时候回调 `showLoading`/`hideLoading`/`displayNotification` 等方法，使用时只需要实现这三个方法即可：
```javascript
import loadingComponent from '/some/path'
import notificationComponent from '/some/other/path'
dao.handlers = {
    showLoading () {
        loadingComponent.show()
    },
    hideLoading () {
        loadingComponent.hide()
    },
    // 参数 error 为 axios 提供的 AxiosError 对象
    displayNotification (error) {
        notificationComponent.show({
            status: error.data.status,
            message: error.data.message,
        })
    }
}
```
当然，如果你不需要这样的功能，不配置即可，不影响使用。

#### 拦截器
dao 继承了 axios 的拦截器机制，使用方法与 axios 完全一致
```javascript
dao.interceptors.request.use(function (config) {
    config.params._timestamp = Date.now()
    return config
})

dao.interceptors.response.then(function (response) {
    // do some pre-process with response
    ...
    return response
})
```

### 直接使用 axios
```javascript
import { axios } from 'dao';
```

## 使用建议
dao 的目的在于统一管理系统中的 API，减少样板代码，提高复用性和可维护性。
建议在项目目录中，建立一个单独的 `dao` 文件夹， 并以业务实体为单元，组织代码，以下是一个示例：
- /src
    - /dao
        - /users.js
        - /books.js

